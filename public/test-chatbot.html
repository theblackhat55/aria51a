<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="p-8">
    <h1 class="text-2xl font-bold mb-4">Chatbot Test Page</h1>
    <p class="mb-4">This page tests if the chatbot JavaScript runs without errors.</p>
  </div>

  <!-- Enhanced AI Assistant Chatbot Widget (Testing: Show on all pages) -->
  <div id="chatbot-widget" class="fixed bottom-6 right-6 z-50">
    <!-- Notification Badge -->
    <div id="chatbot-notification" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center animate-pulse">
      <span id="notification-count">1</span>
    </div>
    
    <!-- Chatbot Toggle Button -->
    <button id="chatbot-toggle" 
            class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300">
      <i class="fas fa-comments text-xl"></i>
    </button>
    
    <!-- Chatbot Panel -->
    <div id="chatbot-panel" class="hidden absolute bottom-16 right-0 w-96 h-[600px] bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
            <i class="fas fa-robot text-sm"></i>
          </div>
          <div>
            <h3 class="font-semibold text-sm">ARIA Assistant</h3>
            <p class="text-xs opacity-75">AI Risk Intelligence</p>
          </div>
        </div>
        <button id="chatbot-close" class="hover:bg-white hover:bg-opacity-10 p-1 rounded transition-colors">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>
      
      <!-- Messages Container -->
      <div id="chatbot-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
        <!-- Welcome message will be added here -->
      </div>
      
      <!-- Input Area -->
      <div class="border-t border-gray-200 p-4">
        <div class="flex space-x-2">
          <input type="text" 
                 id="chatbot-input" 
                 placeholder="Ask about risks, compliance, security..." 
                 class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                 maxlength="500">
          <button id="chatbot-send" 
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
            <i class="fas fa-paper-plane text-sm"></i>
          </button>
        </div>
        <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
          <span id="char-count">0/500</span>
          <div class="flex space-x-2">
            <button class="hover:text-blue-600 transition-colors" title="Clear conversation">
              <i class="fas fa-eraser"></i>
            </button>
            <button class="hover:text-blue-600 transition-colors" title="Export conversation">
              <i class="fas fa-download"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Enhanced Chatbot Widget with Modern Features
    class EnhancedChatbot {
      constructor() {
        this.isOpen = false;
        this.conversationHistory = JSON.parse(localStorage.getItem('aria_chat_history') || '[]');
        this.currentContext = '';
        this.messageCount = 0;
        this.isTyping = false;
        
        this.initializeElements();
        this.bindEvents();
        this.loadConversationHistory();
        
        // Add welcome message if no history
        if (this.conversationHistory.length === 0) {
          this.addWelcomeMessage();
        }
        
        console.log('‚úÖ ARIA Chatbot initialized successfully');
      }
      
      initializeElements() {
        this.widget = document.getElementById('chatbot-widget');
        this.toggle = document.getElementById('chatbot-toggle');
        this.panel = document.getElementById('chatbot-panel');
        this.closeBtn = document.getElementById('chatbot-close');
        this.messagesContainer = document.getElementById('chatbot-messages');
        this.input = document.getElementById('chatbot-input');
        this.sendBtn = document.getElementById('chatbot-send');
        this.charCount = document.getElementById('char-count');
        this.notification = document.getElementById('chatbot-notification');
        this.notificationCount = document.getElementById('notification-count');
      }
      
      bindEvents() {
        // Toggle button
        this.toggle?.addEventListener('click', () => this.toggleChat());
        
        // Close button
        this.closeBtn?.addEventListener('click', () => this.closeChat());
        
        // Send button
        this.sendBtn?.addEventListener('click', () => this.sendMessage());
        
        // Enter key to send
        this.input?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });
        
        // Character counter
        this.input?.addEventListener('input', () => this.updateCharCount());
        
        // Click outside to close
        document.addEventListener('click', (e) => {
          if (this.isOpen && !this.widget?.contains(e.target)) {
            this.closeChat();
          }
        });
      }
      
      toggleChat() {
        console.log('üîÑ Toggle chat called, current state:', this.isOpen);
        if (this.isOpen) {
          this.closeChat();
        } else {
          this.openChat();
        }
      }
      
      openChat() {
        console.log('üìñ Opening chat...');
        this.isOpen = true;
        this.panel?.classList.remove('hidden');
        this.panel?.classList.add('animate-fadeIn');
        this.input?.focus();
        this.hideNotification();
      }
      
      closeChat() {
        console.log('üìï Closing chat...');
        this.isOpen = false;
        this.panel?.classList.add('hidden');
        this.panel?.classList.remove('animate-fadeIn');
      }
      
      sendMessage() {
        const message = this.input?.value.trim();
        if (!message) return;
        
        console.log('üì§ Sending message:', message);
        
        // Add user message
        this.addMessage(message, 'user');
        this.input.value = '';
        this.updateCharCount();
        
        // Show typing indicator
        this.showTyping();
        
        // Make actual API call to the AI service
        this.makeAPICall(message);
      }
      
      async makeAPICall(message) {
        try {
          const response = await fetch('/ai/chat-json', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Cache-Control': 'no-cache'
            },
            body: JSON.stringify({ 
              message: message,
              timestamp: Date.now()
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          this.hideTyping();
          
          const aiResponse = data.response || 'Sorry, I could not process your request.';
          this.addMessage(aiResponse, 'assistant');
          
        } catch (error) {
          console.error('API Error:', error);
          this.hideTyping();
          
          let errorMessage;
          if (error.message.includes('401') || error.message.includes('403')) {
            errorMessage = 'üîê Please log in to use the AI Assistant. Authentication is required for personalized responses.';
          } else {
            errorMessage = 'ü§ñ **ARIA Assistant** (Test Mode)\n\nI\'m experiencing connection issues. Please:\n‚Ä¢ Ensure you\'re logged in\n‚Ä¢ Try the main AI Assistant page\n‚Ä¢ Refresh and try again\n\nThis is the test chatbot widget - for full functionality, use the main application.';
          }
          
          this.addMessage(errorMessage, 'assistant');
        }
      }
      
      addMessage(content, type) {
        console.log('üí¨ Adding message:', { content, type });
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg text-sm ${
          type === 'user' 
            ? 'bg-blue-600 text-white' 
            : 'bg-gray-100 text-gray-800'
        }`;
        
        messageContent.innerHTML = this.formatMessage(content);
        messageDiv.appendChild(messageContent);
        
        this.messagesContainer?.appendChild(messageDiv);
        this.scrollToBottom();
        
        // Save to history
        this.conversationHistory.push({ content, type, timestamp: Date.now() });
        this.saveHistory();
        this.messageCount++;
      }
      
      formatMessage(text) {
        console.log('üé® Formatting message:', text);
        // Enhanced message formatting
        let formatted = this.escapeHtml(text);
        
        // Convert URLs to links
        formatted = formatted.replace(new RegExp('(https?:\\/\\/[^\\s]+)', 'g'), '<a href="$1" target="_blank" class="text-blue-600 hover:underline">$1</a>');
        
        // Convert line breaks
        formatted = formatted.replace(new RegExp('\\n', 'g'), '<br>');
        
        // Highlight important terms
        formatted = formatted.replace(new RegExp('\\b(HIGH|CRITICAL|URGENT)\\b', 'gi'), '<span class="bg-red-100 text-red-800 px-1 rounded">$1</span>');
        formatted = formatted.replace(new RegExp('\\b(LOW|INFORMATIONAL)\\b', 'gi'), '<span class="bg-green-100 text-green-800 px-1 rounded">$1</span>');
        formatted = formatted.replace(new RegExp('\\b(MEDIUM|WARNING)\\b', 'gi'), '<span class="bg-yellow-100 text-yellow-800 px-1 rounded">$1</span>');
        
        return formatted;
      }
      
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      showTyping() {
        this.isTyping = true;
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex justify-start';
        typingDiv.innerHTML = `
          <div class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg text-sm max-w-xs">
            <div class="flex items-center space-x-1">
              <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
              </div>
              <span class="text-gray-500">ARIA is typing...</span>
            </div>
          </div>
        `;
        this.messagesContainer?.appendChild(typingDiv);
        this.scrollToBottom();
      }
      
      hideTyping() {
        this.isTyping = false;
        const typingIndicator = document.getElementById('typing-indicator');
        typingIndicator?.remove();
      }
      
      scrollToBottom() {
        if (this.messagesContainer) {
          this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }
      }
      
      updateCharCount() {
        const length = this.input?.value.length || 0;
        if (this.charCount) {
          this.charCount.textContent = `${length}/500`;
          this.charCount.className = length > 450 ? 'text-red-500' : 'text-gray-500';
        }
      }
      
      addWelcomeMessage() {
        const welcomeMessage = `Hello! I'm ARIA, your AI Risk Intelligence Assistant. I can help you with:

‚Ä¢ Risk assessment and analysis
‚Ä¢ Compliance framework guidance
‚Ä¢ Security recommendations
‚Ä¢ Operational risk management
‚Ä¢ Threat intelligence insights

How can I assist you today?`;
        
        this.addMessage(welcomeMessage, 'assistant');
      }
      
      loadConversationHistory() {
        this.conversationHistory.forEach(message => {
          this.addHistoryMessage(message.content, message.type);
        });
      }
      
      addHistoryMessage(content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg text-sm ${
          type === 'user' 
            ? 'bg-blue-600 text-white' 
            : 'bg-gray-100 text-gray-800'
        }`;
        
        messageContent.innerHTML = this.formatMessage(content);
        messageDiv.appendChild(messageContent);
        
        this.messagesContainer?.appendChild(messageDiv);
      }
      
      saveHistory() {
        localStorage.setItem('aria_chat_history', JSON.stringify(this.conversationHistory));
      }
      
      showNotification(count = 1) {
        if (this.notification && this.notificationCount) {
          this.notificationCount.textContent = count.toString();
          this.notification.classList.remove('hidden');
        }
      }
      
      hideNotification() {
        this.notification?.classList.add('hidden');
      }
    }
    
    // Initialize chatbot when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Checking for chatbot elements...');
      const chatbotWidget = document.getElementById('chatbot-widget');
      const chatbotToggle = document.getElementById('chatbot-toggle');
      console.log('ü§ñ Chatbot widget:', chatbotWidget ? 'found' : 'not found');
      console.log('üîò Chatbot toggle:', chatbotToggle ? 'found' : 'not found');
      
      if (chatbotWidget && chatbotToggle) {
        console.log('üéØ Initializing Enhanced Chatbot...');
        window.ariaChatbot = new EnhancedChatbot();
        console.log('üöÄ Enhanced ARIA Chatbot ready (testing mode)');
      } else {
        console.warn('‚ö†Ô∏è Chatbot elements not found, skipping initialization');
        console.log('üîç Available elements:', {
          widget: !!document.getElementById('chatbot-widget'),
          toggle: !!document.getElementById('chatbot-toggle'),
          panel: !!document.getElementById('chatbot-panel'),
          input: !!document.getElementById('chatbot-input')
        });
      }
    });
  </script>
</body>
</html>